<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<html lang="en">
    <title>Dataviz</title>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.min.js" integrity="sha512-sW/w8s4RWTdFFSduOTGtk4isV1+190E/GghVffMA9XczdJ2MDzSzLEubKAs5h0wzgSJOQTRYyaz73L3d6RtJSg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>
        <script src="https://unpkg.com/topojson@3.0.2/dist/topojson.js"> </script>
    </head>
    <body>

        <style>

            body {
                margin: 0.1vh 0.5vw;
            }

            .row {
                display: flex;
            }

            .column {
                flex: 50%;
            }

            .chart_column {

                flex: 70%;
            }

            #map {
                height: 100vh;
                width: 100vw;
            }

            .map-wrapper {

                height: 100%;
                width: 40%;
                display: flex;
            }

        </style>

        
        <div class="row">
            <div class="map-wrapper">
                <div id="map" class="map_column"></div>
            </div>

            <div class="chart-container chart_column" style="position: relative; height:100vh; width: 80vw;">
                <canvas id="myChart"></canvas>
            </div>
            
        </div>

        <script>
            var commune = "";
            //zoom levels are used to help us know the current state of the app
            //values:
            // initial
            // region
            // commune
            var current_zoom = "initial";
            
            var map = L.map('map').setView([42.158115, 9.031013], 9);
            map.options.minZoom = 9;
            map.setMaxBounds(map.getBounds());

            var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            var json_data;

            //extend Leaflet to create a GeoJSON layer from a TopoJSON file
            L.TopoJSON = L.GeoJSON.extend({
                addData: function (data) {
                var geojson, key;
                if (data.type === "Topology") {
                    json_data = data;
                    for (key in data.objects) {
                        if (data.objects.hasOwnProperty(key)) {
                            geojson = topojson.feature(data, data.objects[key]);
                            L.GeoJSON.prototype.addData.call(this, geojson);
                        }
                    }
                    return this;
                }
                L.GeoJSON.prototype.addData.call(this, data);
                return this;
                }
            });

            L.topoJson = function(json, options) {
                return new L.TopoJSON(json, options);
            };

            var regions = {
                "Balagna": {
                    "name": "Balagna",
                    "color": "#13e735",
                    "communes" : [
                        "Algajola",
                        "Aregno",
                        "Avapessa",
                        "Belgodère",
                        "Calenzana",
                        "Calvi",
                        "Cateri",
                        "Corbara",
                        "Costa",
                        "Feliceto",
                        "L'Île-Rousse",
                        "Lavatoggio",
                        "Lumio",
                        "Moncale",
                        "Montegrosso",
                        "Monticello",
                        "Muro",
                        "Nessa",
                        "Occhiatana",
                        "Pigna",
                        "Sant'Antonino",
                        "Santa-Reparata-di-Balagna",
                        "Speloncato",
                        "Ville-di-Paraso",
                        "Zilia"
                    ]
                },
                
                "Nebbiu": {
                    "name": "Nebbiu",
                    "color": "#13e200",
                    "communes" : [
                        "Barbaggio",
                        "Farinole",
                        "Murato",
                        "Oletta",
                        "Olmeta-di-Tuda",
                        "Patrimonio",
                        "Piève",
                        "Poggio-d'Oletta",
                        "Rapale",
                        "Rutali",
                        "Saint-Florent",
                        "San-Gavino-di-Tenda",
                        "Santo-Pietro-di-Tenda",
                        "Sorio",
                        "Vallecalle"
                    ]
                },

                "Capicorsu": {
                    "name": "Capicorsu",
                    "color": "#09e735",
                    "communes": [
                        "Barrettali",
                        "Brando",
                        "Cagnano",
                        "Canari",
                        "Centuri",
                        "Ersa",
                        "Luri",
                        "Meria",
                        "Morsiglia",
                        "Nonza",
                        "Ogliastro",
                        "Olcani",
                        "Olmeta-di-Capocorso",
                        "Pietracorbara",
                        "Pino",
                        "Rogliano",
                        "Sisco",
                        "Tomino"
                    ]
                },

                "Bagnaja": {
                    "name": "Bagnaja",
                    "color": "#09e200",
                    "communes": [
                        "Bastia",
                        "San-Martino-di-Lota",
                        "Biguglia",
                        "Borgo",
                        "Lucciana",
                        "Bigorno",
                        "Campitello",
                        "Canavaggia",
                        "Santa-Maria-di-Lota",
                        "Ville-di-Pietrabugno",
                        "Furiani",
                        "Vignale",
                        "Lento",
                        "Scolca",
                        "Volpajola"
                    ]
                },

                "Castagniccia": {
                    "name": "Castagniccia",
                    "color": "#09e735",
                    "communes": [
                        "Bisinchi",
                        "Castello-di-Rostino",
                        "Castineta",
                        "Gavignano",
                        "Campile",
                        "Crocicchia",
                        "Monte",
                        "Olmo",
                        "Morosaglia",
                        "Saliceto",
                        "Valle-di-Rostino",
                        "Ortiporio",
                        "Penta-Acquatella",
                        "Prunelli-di-Casacconi",
                        "Casalta",
                        "Casabianca",
                        "Croce",
                        "Ficaja",
                        "Giocatojo",
                        "La Porta",
                        "Piano",
                        "Poggio-Marinaccio",
                        "Polveroso",
                        "Pruno",
                        "Quercitello",
                        "San-Damiano",
                        "San-Gavino-d'Ampugnani",
                        "Scata",
                        "Silvareccio",
                        "Castellare di Casinca",
                        "Loreto di Casinca",
                        "Penta di Casinca",
                        "Porri",
                        "Sorbo-Ocagnano",
                        "Venzolasca",
                        "Vescovato",
                        "Pero-Casevecchie",
                        "Poggio-Mezzana",
                        "Taglio-Isolaccio",
                        "Talasani",
                        "Velone-Orneto",
                        "San-Giovanni-di-Moriani",
                        "San-Nicolao",
                        "Santa-Lucia-di-Moriani",
                        "Santa-Maria-Poggio",
                        "Santa-Reparata-di-Moriani",
                        "Camapana",
                        "Carcheto-Brustico",
                        "Carpineto",
                        "Monacia-d'Orezza",
                        "Nocario",
                        "Parata",
                        "Piazzole",
                        "Pie-d'Orezza",
                        "Piedicroce",
                        "Piedipartino",
                        "Rapaggio",
                        "Stazzona",
                        "Valle-d'Orezza",
                        "Verdese",
                        "Felce",
                        "Novale",
                        "Ortale",
                        "Perelli",
                        "Piazzali",
                        "Pietricaggio",
                        "Piobetta",
                        "Tarrano",
                        "Valle-d'Alesani",
                        "Cervione",
                        "San-Giuliano",
                        "Sant'Andréa-di-Cotone",
                        "Valle-di-Campoloro",
                        "Campi",
                        "Canale-di-Verde",
                        "Chiatra",
                        "Linguizzetta",
                        "Pietra-di-Verde",
                        "Tox",
                        "Aiti",
                        "Cambia",
                        "Carticasi",
                        "Érone",
                        "Lano",
                        "Rusio",
                        "San-Lorenzo"
                    ]
                },

                "Curtinese": {
                    "name": "Curtinese",
                    "color": "#09e735",
                    "communes": [
                        "Castiglione",
                        "Piedigriggio",
                        "Popolasca",
                        "Prato-di-Giovellina",
                        "Albertacce",
                        "Calacuccia",
                        "Casamaccioli",
                        "Corscia",
                        "Lozzi",
                        "Castirla",
                        "Corte",
                        "Omessa",
                        "Santa-Lucia-di-Mercurio",
                        "Soveria",
                        "Tralonca",
                        "Casanova",
                        "Poggio-di-Venaco",
                        "Venaco",
                        "Muracciole",
                        "Noceta",
                        "Rospigliani",
                        "Vivario"
                    ]
                },

                "Tavignanu": {
                    "name": "Tavignanu",
                    "color": "#fff",
                    "communes": [
                        "Aghione",
                        "Aléria",
                        "Casevecchie",
                        "Ghisonaccia",
                        "Alando",
                        "Alzi",
                        "Bustanico",
                        "Castellare-di-Mercurio",
                        "Favalello",
                        "Mazzola",
                        "Sant'Andrea-di-Bozio",
                        "Sermano",
                        "Altiani",
                        "Antisanti",
                        "Erbajolo",
                        "Focicchia",
                        "Giuncaggio",
                        "Pancheraccia",
                        "Piedicorte-di-Gaggio",
                        "Pietraserena",
                        "Ampriani",
                        "Moïta",
                        "Matra",
                        "Pianello",
                        "Tallone",
                        "Zalana",
                        "Zuani"
                    ]
                },

                "Fiumorbu": {
                    "name": "Fiumorbo",
                    "color": "#ffff",
                    "communes": [
                        "Ghisoni",
                        "Lugo-di-Nazza",
                        "Pietroso",
                        "Poggio-di-Nazza",
                        "Vezzani",
                        "Isolaccio-di-Fiumorbo",
                        "Prunelli-di-Fiumorbo",
                        "San-Gavino-di-Fiumorbo",
                        "Chisa",
                        "Serra-di-Fiumorbo",
                        "Solaro",
                        "Ventiseri"
                    ]
                },

                "Bunifaziu": {
                    "name": "Bunifaziu",
                    "color": "#00000",
                    "communes": [
                        "Bonifacio",
                        "Figari",
                        "Monacia-d'Aullène",
                        "Pianottoli-Caldarello",
                        "Sotta",
                        "Conca",
                        "Lecci",
                        "Porto-Vecchio",
                        "Sari-Solenzara"
                    ]
                },

                "Rocca": {
                    "name": "Rocca",
                    "color": "#12eF",
                    "communes": [
                        "Belvédère-Campomoro",
                        "Bilia",
                        "Foce",
                        "Giuncheto",
                        "Granace",
                        "Grossa",
                        "Sartène",
                        "Arbellara",
                        "Fozzano",
                        "Propriano",
                        "Santa-Maria-Figaniella",
                        "Viggianello"
                    ]
                },

                "Alta Rocca": {
                    "name": "Alta Rocca",
                    "color": "#3232",
                    "communes": [
                        "Carbini",
                        "Levie",
                        "San-Gavino-di-Carbini",
                        "Zonza",
                        "Altagène",
                        "Cargiaca",
                        "Loreto-di-Tallano",
                        "Mela",
                        "Olmiccia",
                        "Sainte-Lucie-de-Tallano",
                        "Zoza",
                        "Aullène",
                        "Quenza",
                        "Serra-di-Scopamène",
                        "Sorbollano",
                        "Zérubia"
                    ]
                },

                "Taravu": {
                    "name": "Taravu",
                    "color": "#ff0000",
                    "communes": [
                        "Argiusta-Moriccio",
                        "Casalabriva",
                        "Moca-Croce",
                        "Olivese",
                        "Olmeto",
                        "Petreto-Bicchisano",
                        "Sollacaro",
                        "Ciamannacce",
                        "Corrano",
                        "Cozzano",
                        "Guitera-les-Bains",
                        "Palneca",
                        "Sampolo",
                        "Tasso",
                        "Zévaco",
                        "Zicavo",
                        "Albitreccia",
                        "Azilone-Ampaza",
                        "Cardo-Torgia",
                        "Campo",
                        "Cognocoli-Monticchi",
                        "Coti-Chiavari",
                        "Forciolo",
                        "Frasseto",
                        "Grosseto-Prugna",
                        "Guargualé",
                        "Pietrosella",
                        "Pila-Canale",
                        "Quasquara",
                        "Santa-Maria-Siché",
                        "Serra-di-Ferro",
                        "Urbalacone",
                        "Zigliara"
                    ]
                },

                "Gravona-Prunelli": {
                    "name": "Gravona-Prunelli",
                    "color": "#ff0000",
                    "communes": [
                        "Ajaccio",
                        "Alata",
                        "Appietto",
                        "Villanova",
                        "Afa",
                        "Cuttoli-Corticchiato",
                        "Peri",
                        "Sarrola-Carcopino",
                        "Tavaco",
                        "Valle-di-Mezzana",
                        "Bocognano",
                        "Carbuccia",
                        "Tavera",
                        "Ucciani",
                        "Vero",
                        "Bastelica",
                        "Bastelicaccia",
                        "Cauro",
                        "Eccica-Suarella",
                        "Ocana",
                        "Tolla"
                    ]
                },

                "Liamone": {
                    "name": "Liamone",
                    "color": "#ff0000",
                    "communes": [
                        "Ambiegna",
                        "Arro",
                        "Calcatoggio",
                        "Cannelle",
                        "Casaglione",
                        "Lopigna",
                        "Sant'Andréa-d'Orcino",
                        "Sari-d'Orcino",
                        "Azzana",
                        "Pastricciola",
                        "Rezza",
                        "Rosazia",
                        "Salice",
                        "Arbori",
                        "Balogna",
                        "Coggia",
                        "Letia",
                        "Murzo",
                        "Renno",
                        "Vico",
                        "Guagno",
                        "Orto",
                        "Poggiolo",
                        "Soccia"
                    ]
                },

                "Duii Sevi": {
                    "name": "Duii Sevi",
                    "color": "#ff0000",
                    "communes": [
                        "Cristinacce",
                        "Évisa",
                        "Marignana",
                        "Cargèse",
                        "Ota",
                        "Piana",
                        "Osani",
                        "Partinello",
                        "Serriera"
                    ]
                }
            };

            //take in a feature, read its name, and returns the region specific things
            function getRegionSpecs(feature) {
                Object.entries(regions).forEach(([key, value]) => {
                    if (value.communes.includes(feature.properties.libgeo)) {
                        
                        console.log(feature.properties.libgeo + " is in " + regions[key].name);
                        return {
                            name: regions[key].name,
                            color: regions[key].color
                        }
                    }
                });
            }

            //create an empty geojson layer
            //with a style and a popup on click

            var geojson = L.topoJson(null, {
                style: function(feature){
                    return {
                        color: "#000",
                        opacity: 1,
                        weight: 1,
                        fillColor: "#000",
                        fillOpacity: 0.2
                    }
                },
                onEachFeature: function(feature, layer) {
                    console.log(feature);

                    featureBounds = L.geoJson(feature).getBounds();

                    var sw = featureBounds.getSouthWest();
                    var ne = featureBounds.getNorthEast();
                    var southWest = new L.LatLng(sw.lat, sw.lng);
                    var northEast = new L.LatLng(ne.lat, ne.lng);
                    bounds = new L.LatLngBounds(southWest, northEast);
                    console.log(bounds);

                    layer.bindPopup('<p>'+feature.properties.libgeo+'</p>').on('click', function() { commune = (feature.properties.libgeo); map.fitBounds(getBoundsFromFeature(this)); });

                },
            }).addTo(map);

            //takes in a feature, and gives back the bounds to zoom to
            function getBoundsFromFeature(feature) {
                featureBounds = feature.getBounds();

                var sw = featureBounds.getSouthWest();
                var ne = featureBounds.getNorthEast();
                var southWest = new L.LatLng(sw.lat, sw.lng);
                var northEast = new L.LatLng(ne.lat, ne.lng);
                bounds = new L.LatLngBounds(southWest, northEast);

                return bounds;
            }

            //fill: #317581;
            //define a function to get and parse geojson from URL
            async function getGeoData(url) {
                let response = await fetch(url);
                let data = await response.json();
                return data;
            }
            
            //fetch the geojson and add it to our geojson layer
            getGeoData('communes_4326.json').then(data => geojson.addData(data));

        </script>
        <script>
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                datasets: [{
                    label: '# of Votes',
                    data: [12, 19, 3, 5, 2, 3],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        </script>
    </body>
</html>